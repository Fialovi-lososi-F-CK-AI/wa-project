- name: Atomic deploy frontend (React static)
  hosts: dev-node
  become: true
  strategy: linear

  vars:
    frontend_root: /opt/app/frontend
    releases_dir: "{{ frontend_root }}/releases"
    current_link: "{{ frontend_root }}/current"
    release_name: "{{ ansible_date_time.iso8601_basic }}"
    release_dir: "{{ releases_dir }}/{{ release_name }}"
    keep_releases: 5
    
  tasks:
    - name: Rollback to specific release (manual)
      file:
        src: "{{ releases_dir }}/{{ rollback_release }}"
        dest: "{{ current_link }}"
        state: link
        force: true
      when: rollback_release is defined
      tags: rollback

    - name: Ensure frontend root dirs exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ frontend_root }}"
        - "{{ releases_dir }}"
      when: rollback_release is not defined

    - name: Create release directory
      file:
        path: "{{ release_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: rollback_release is not defined

    - name: Upload frontend build (dist)
      copy:
        src: "{{ playbook_dir }}/../src/frontend/dist/"
        dest: "{{ release_dir }}/"
        owner: root
        group: root
        mode: "0644"
        directory_mode: "0755"
      when: rollback_release is not defined

    - name: Verify index.html exists
      stat:
        path: "{{ release_dir }}/index.html"
      register: index_file
      when: rollback_release is not defined

    - name: Abort if build is invalid
      fail:
        msg: "index.html not found in release {{ release_name }}"
      when:
        - rollback_release is not defined
        - not index_file.stat.exists

    - name: Switch current symlink atomically
      file:
        src: "{{ release_dir }}"
        dest: "{{ current_link }}"
        state: link
        force: true
      when: rollback_release is not defined

    - name: Stop nginx container
      docker_container:
        name: nginx
        state: stopped

    - name: Start nginx container
      docker_container:
        name: nginx
        state: started

    - name: Wait for Nginx to be ready
      wait_for:
        host: localhost
        port: 443
        delay: 1
        timeout: 10

    - name: Check frontend is reachable
      uri:
        url: https://localhost/
        status_code: 200
        validate_certs: no
        headers:
          Host: local.dev
      when: rollback_release is not defined

    - name: Cleanup old releases (keep last {{ keep_releases }})
      shell: |
        set -o pipefail
        ls -1dt {{ releases_dir }}/* | tail -n +{{ keep_releases + 1 }} | xargs rm -rf
      args:
        executable: /bin/bash
      changed_when: false
      when: rollback_release is not defined
